'use strict';define(['common/kernel/kernel','site/util/util'],function(a,b){function c(a,b){var c=new SockJS(''+('https:'==location.protocol?'https:':'http:')+'//www.delicloud.com/web/web-gateway-websocket');s=Stomp.over(c),s.connect({},function(){d(a,'/user/'+a+'/barcode/login',b)})}function d(a,c,d){s.subscribe('/user/'+a+'/info',function(a){var b=JSON.parse(a.body);u.data=b,j.hide(),m.hide(),k.find('div.success-img').css({"background-image":'url('+b.avatar_url+')'}).attr('title',b.name),k.show()}),s.subscribe(c,function(a){var c=JSON.parse(a.body);c&&c.user_id?(t=c,'web'==t.type&&(b.setCookie('token',t.token),b.setCookie('userid',t.user_id),b.setCookie('expire',t.expire)),d&&'disconnect'==d&&e(),f(o,{userid:t.user_id,token:t.token})):v(h.find('.loginQr'))})}function e(){null!=s&&s.disconnect()}function f(c,d){b.ajaxSubmit({type:'get',url:'/v1.0/admin/auth/my',dauth:d.userid+' '+new Date().valueOf()+' '+a.buildDauth(d.userid,d.token,new Date().valueOf()),data:{type:'group'},success:function success(d){if(0==d.code){c.find('>').remove('');var e=d.data.result;if(e&&e.length&&0<e.length){var f=[],g=e.length,l=0;$.each(e,function(d,e){if(e.is_admin&&!0==e.is_admin||e.department_ids||e.app_ids||e.device_ids){l=d;var h=$('<li class="list-item"><a class="list-item-inner noline" href="javascript:;" title="'+e.org_name+'" data-oid="'+e.org_id+'" data-pid="'+e.top_department_id+'">'+e.org_name+'</a></li>');return f.push(e),c.append(h),function(){var c={name:e.org_name,orgid:e.org_id,parentid:e.top_department_id,app_ids:e.app_ids?e.app_ids.length:0,device_ids:e.device_ids?e.device_ids.length:0,employee_count:e.employee_count};h.find('a.list-item-inner').on('click',function(d){d.stopPropagation(),b.setCookie('orgid',c.orgid),b.setCookie('parentid',c.parentid),b.setCookie('orgname',c.name),b.setCookie('device_ids',c.device_ids),b.setCookie('app_ids',c.app_ids),b.setCookie('employee_count',c.employee_count),u.orgindex=$(this).parent('li.list-item').index(),b.setCookie('orgindex',u.orgindex),b.setUserData(u),a.replaceLocation({args:{},id:'home'})})}()}g--}),u.organization=f,0>=g?(h.show(),p.hide(),j.hide(),k.hide(),k.find('div.success-img').css({"background-image":'url('+d.avatar_url+')'}).attr('title',d.name),m.show()):1==g?(h.show(),p.hide(),j.show(),k.hide(),m.hide(),v(h.find('.loginQr')),b.setCookie('orgid',e[l].org_id),b.setCookie('parentid',e[l].top_department_id),b.setCookie('orgname',e[l].org_name),b.setCookie('device_ids',e[l].device_ids?e[l].device_ids.length:0),b.setCookie('app_ids',e[l].app_ids?e[l].app_ids.length:0),b.setCookie('employee_count',e[l].employee_count),u.orgindex=l,b.setUserData(u),a.replaceLocation({args:{},id:'home'})):(h.hide(),p.show(),j.show(),k.hide(),m.hide(),v(h.find('.loginQr')),4>=g?c.addClass('org-list-seldom'):c.addClass('org-list-plenty'))}else h.show(),p.hide(),j.hide(),k.hide(),k.find('div.success-img').css({"background-image":'url('+d.avatar_url+')'}).attr('title',d.name),m.show()}else a.hint(d.msg)}})}var g=$('#loginhome'),h=g.find('.login-box'),i=h.find('#loginQr'),j=i.find('.login-doing'),k=i.find('.login-success'),l=k.find('.success-btn'),m=i.find('.login-fail'),n=m.find('.fail-btn'),p=g.find('.org-box'),o=p.find('.org-wrap .org-inner .org-list'),q=$('#header .nav-top .nav-top-list .nav-item-team'),r=q.find('.son-nav-list-team'),s=null,t={},u={data:{},organization:{}},v=function(d){d.addClass('login-loading'),b.ajaxSubmit({url:'/v1.0/barcode_login/public',silent:!0,type:'get',success:function success(b){if(d.removeClass('login-loading'),0==b.code){var e=b.data.result,f=e.cid,g=e.data;g?(d.html(''),new QRCode(document.getElementById('qrcode'),{text:g,width:234,height:234,correctLevel:QRCode.CorrectLevel.L}),c(f,'disconnect')):d.html('')}else a.hint(b.msg)},error:function error(){d.removeClass('login-loading'),a.hint('\u7F51\u7EDC\u6216\u670D\u52A1\u5668\u9519\u8BEF~','error')}})};return v(h.find('.loginQr')),$(document).on('click','.loginQr',function(){var d=this,e=h.find('.loginQr'),f=e[this===e[0]?1:0];0===this.childNodes.length&&(f&&0<f.childNodes.length?this.innerHTML=f.innerHTML:b.ajaxSubmit({url:'/v1.0/barcode_login/public',silent:!0,type:'get',success:function success(b){if(0==b.code){var d=b.data.result,f=d.cid,g=d.data;g?(e.html(''),new QRCode(document.getElementById('qrcode'),{text:g,width:234,height:234,correctLevel:QRCode.CorrectLevel.L}),c(f)):e.html('')}else a.hint(b.msg)}}))}),l.on('click',function(){v(h.find('.loginQr'),'disconnect'),m.hide(),k.hide(),j.show()}),n.on('click',function(){v(h.find('.loginQr'),'disconnect'),m.hide(),k.hide(),j.show()}),{onload:function onload(){var a,c,d,e,f;a=b.getCookie('userid'),c=b.getCookie('token'),d=b.getCookie('orgid'),e=b.getCookie('orgname'),f=b.getCookie('parentid'),'undefined'!=a&&'undefined'!=c&&'undefined'!=d&&'undefined'!=e&&'undefined'!=f&&(h.show(),p.hide())}}});