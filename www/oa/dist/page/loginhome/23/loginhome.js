'use strict';define(['common/kernel/kernel','site/util/util'],function(a,b){function c(a){if('undefined'!=typeof WebSocket){var c=new WebSocket(a.ws_url);c.onopen=function(){c.send('{"cmd": "register","data": "'+a.session_id+'"}')},c.onmessage=function(a){var d=JSON.parse(a.data);d&&(d.id&&(t.data=d,j.hide(),m.hide(),k.find('div.success-img >').remove(),k.find('div.success-img').append('<img src="'+d.avatar_url+'" title="'+d.name+'">'),k.show()),d.user_id&&(s=d,'web'==s.type&&(b.setCookie('token',s.token),b.setCookie('userid',s.user_id),b.setCookie('expire',s.expire)),e(o,{userid:s.user_id,token:s.token,type:'websocket'},c)))},c.onclose=function(){},c.onerror=function(){}}else var f=setInterval(function(){d(a.http_url,f)},3e3)}function d(a,c){$.getJSON(a).done(function(a){var d=a;if(1<d.length){var f=d[0],g=d[1];f&&g&&(f.id&&(t.data=f,j.hide(),m.hide(),k.find('div.success-img >').remove(),k.find('div.success-img').append('<img src="'+f.avatar_url+'" title="'+f.name+'">'),k.show()),g.user_id&&(s=g,'web'==s.type&&(b.setCookie('token',s.token),b.setCookie('userid',s.user_id),b.setCookie('expire',s.expire)),e(o,{userid:s.user_id,token:s.token,type:'polling'},function(){clearInterval(c)})))}else if(1==d.length){var h=d[0];h&&(h.id&&(t.data=h,j.hide(),m.hide(),k.find('div.success-img >').remove(),k.find('div.success-img').append('<img src="'+h.avatar_url+'" title="'+h.name+'">'),k.show()),h.user_id&&(s=h,'web'==s.type&&(b.setCookie('token',s.token),b.setCookie('userid',s.user_id),b.setCookie('expire',s.expire)),e(o,{userid:s.user_id,token:s.token,type:'polling'},function(){clearInterval(c)})))}})}function e(c,d,e){var g=new Date().valueOf().toString();'undefined'!=typeof d.userid&&b.ajaxSubmit({type:'get',url:'/v1.0/user/me',dauth:d.userid+' '+g+' '+a.buildDauth(d.userid,d.token,g),data:{},success:function success(g){if(0==g.code){c.find('>').remove('');var i=g.data.organization;if(i&&i.length&&0<i.length){var l=[],n=i.length,o=0;$.each(i,function(e,g){o=e;var h='group'==g.type?'<i class="iconfont icon-group">&#xe643;</i>':'<i class="iconfont icon-user">&#xe642;</i>',i=$('<li class="list-item"><a class="list-item-inner noline" href="javascript:;" title="'+g.name+'" data-oid="'+g.id+'" data-pid="'+g.top_department_id+'"><span class="list-item-text">'+h+''+g.name+'</span></a></li>');return l.push(g),c.append(i),function(){var c={name:g.name,orgid:g.id,parentid:g.top_department_id,employee_count:g.employee_cnt};i.find('a.list-item-inner').on('click',function(g){g.stopPropagation(),b.setCookie('orgid',c.orgid),b.setCookie('parentid',c.parentid),b.setCookie('orgname',c.name),b.setCookie('employee_count',c.employee_count),t.orgindex=$(this).parent('li.list-item').index(),t.orgindexid=t.organization[t.orgindex].id,b.setCookie('orgindex',t.orgindex),b.setCookie('orgindexid',t.orgindexid),t.organization[t.orgindex].admin_id&&t.organization[t.orgindex].admin_id==d.userid?(b.setCookie('orgindexadmin',!0),t.orgindexadmin=!0,b.setUserData(t),a.replaceLocation({args:{},id:'appentry'})):f({userid:d.userid,token:d.token,orgid:c.orgid,parentid:c.parentid},function(c){console.log('orgindexadmin',c),b.setCookie('orgindexadmin',c),t.orgindexadmin=c,b.setUserData(t),a.replaceLocation({args:{},id:'appentry'})})})}()}),t.organization=l,0>=n?(h.show(),p.hide(),j.hide(),k.hide(),k.find('div.success-img >').remove(),k.find('div.success-img').append('<img src="'+g.avatar_url+'" title="'+g.name+'">'),m.show()):1==n?(h.show(),p.hide(),j.show(),k.hide(),m.hide(),b.setCookie('orgid',i[o].id),b.setCookie('parentid',i[o].top_department_id),b.setCookie('orgname',i[o].name),b.setCookie('employee_count',i[o].employee_cnt),t.orgindex=0,t.orgindexid=t.organization[0].id,b.setCookie('orgindex',t.orgindex),b.setCookie('orgindexid',t.orgindexid),t.organization[t.orgindex].admin_id&&t.organization[t.orgindex].admin_id==d.userid?(b.setCookie('orgindexadmin',!0),t.orgindexadmin=!0,b.setUserData(t),a.replaceLocation({args:{},id:'appentry'})):f({userid:d.userid,token:d.token,orgid:g.orgid,parentid:g.parentid},function(c){console.log('orgindexadmin',c),b.setCookie('orgindexadmin',c),t.orgindexadmin=c,b.setUserData(t),a.replaceLocation({args:{},id:'appentry'})}),a.replaceLocation({args:{},id:'appentry'})):(h.hide(),p.show(),j.show(),k.hide(),m.hide(),4>=n?c.addClass('org-list-seldom'):c.addClass('org-list-plenty'))}else h.show(),p.hide(),j.hide(),k.hide(),k.find('div.success-img >').remove(),k.find('div.success-img').append('<img src="'+g.avatar_url+'" title="'+g.name+'">'),m.show();'websocket'==d.type?e.close():'polling'==d.type&&'function'==typeof e&&e()}else a.hint(g.msg)},error:function error(b){a.hint(b.msg)}})}function f(c,d){var e=new Date().valueOf().toString();b.ajaxSubmit({type:'get',url:'/v1.0/admin/group/'+c.orgid+'',dauth:c.userid+' '+e+' '+a.buildDauth(c.userid,c.token,e),data:{},success:function success(b){if(0==b.code){var e=[];0<b.data.result.length&&$.each(b.data.result,function(a,b){$.each(b.admin_ids,function(a,b){e.push(b)})}),'function'==typeof d&&d(!!(0<=$.inArray(c.userid,e)))}else a.hint(b.msg)},error:function error(b){a.hint(b.msg)}})}var g=$('#loginhome'),h=g.find('.login-box'),i=h.find('#loginQr'),j=i.find('.login-doing'),k=i.find('.login-success'),l=k.find('.success-btn'),m=i.find('.login-fail'),n=m.find('.fail-btn'),p=g.find('.org-box'),o=p.find('.org-wrap .org-inner .org-list'),q=$('#header .nav-top .nav-top-list .nav-item-team'),r=q.find('.son-nav-list-team'),s={},t={data:{},organization:{}},u=function(d){d.addClass('login-loading'),b.ajaxSubmit({url:'/v1.0/barcode_login/public?v='+new Date().getTime(),silent:!0,type:'get',success:function success(b){if(d.removeClass('login-loading'),0==b.code){var e=b.data.result,f=e.cid,g=e.data,h=e.session;g?(d.html(''),new QRCode(document.getElementById('qrcode'),{text:g,width:234,height:234,correctLevel:QRCode.CorrectLevel.L}),c(h)):d.html('')}else a.hint(b.msg)},error:function error(){d.removeClass('login-loading'),a.hint('\u7F51\u7EDC\u5F02\u5E38\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5','error')}})};return u(h.find('.loginQr')),$(document).on('click','.loginQr',function(){var a=this,b=h.find('.loginQr'),c=b[this===b[0]?1:0];0===this.childNodes.length?c&&0<c.childNodes.length?this.innerHTML=c.innerHTML:u(h.find('.loginQr')):u(h.find('.loginQr'))}),l.on('click',function(){u(h.find('.loginQr')),m.hide(),k.hide(),j.show()}),n.on('click',function(){u(h.find('.loginQr')),m.hide(),k.hide(),j.show()}),{onload:function onload(){var a,c,d,e,f;a=b.getCookie('userid'),c=b.getCookie('token'),d=b.getCookie('orgid'),e=b.getCookie('orgname'),f=b.getCookie('parentid'),'undefined'!=a&&'undefined'!=c&&'undefined'!=d&&'undefined'!=e&&'undefined'!=f&&(h.show(),p.hide())}}});