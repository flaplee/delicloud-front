'use strict';define(['common/kernel/kernel','site/util/util','page/imports/member','common/text/text!page/imports/steps.html!strip'],function(a,b,c,d){var f=a.parseHash(location.hash),e=b.getCookie('userid'),g=b.getCookie('token'),h=b.getCookie('orgid'),j=!1;return c(function(){function c(){a.showLoading();var c=b.getCookie('userid'),d=b.getCookie('token'),e=b.getCookie('orgid'),h=new Date().valueOf().toString();return $.ajaxFileUpload({url:'/web/v1.0/import/employee',secureuri:!1,fileElementId:'upload-file',dataType:'json',beforeSend:function beforeSend(b){b.setRequestHeader('Duagent','_web'),b.setRequestHeader('Dauth',c+' '+h+' '+a.buildDauth(c,d,h))},ajaxSend:function ajaxSend(b){b.setRequestHeader('Duagent','_web'),b.setRequestHeader('Dauth',c+' '+h+' '+a.buildDauth(c,d,h))},data:{org_id:e,Duagent:'_web',Dauth:c+' '+h+' '+a.buildDauth(c,d,h)},success:function success(b){var c=$.parseJSON(jQuery(b.responseText).text());if(0==c.code){j=!0;var b=c.data.result;if(b&&b.session_id){var d=0;g(b,d++,function(){a.hideLoading()})}}else a.hideLoading(),j=!1,f.args.type='steps',f.args.status='error',a.hint(c.msg,'error'),setTimeout(function(){f.args.type='steps',f.args.status='data',f.args.imports='unable',a.replaceLocation(f)},1e3);a.replaceLocation(f)},error:function error(b){var c=$.parseJSON(jQuery(b.responseText).text());if(0==c.code){j=!0;var b=c.data.result;if(b&&b.session_id){var d=0;g(b,d++,function(){a.hideLoading()})}}else a.hideLoading(),j=!1,f.args.type='steps',f.args.status='error',a.hint(c.msg,'error'),'9103101'==c.code?(p.find('p.user-error-title').hide(),p.find('p.authority-error-title').show()):(p.find('p.user-error-title').show(),p.find('p.authority-error-title').hide());a.replaceLocation(f)}}),!1}function e(b,c,d,e,g){if(0==d&&(b.find('>').remove(),'enable'==c?(a.hint('\u5BFC\u5165\u6210\u529F~'),f.args.type='steps',f.args.status='success'):(a.hint('\u5BFC\u5165\u5931\u8D25~','error'),f.args.type='steps',f.args.status='error'),setTimeout(function(){f.args.type='steps',f.args.status='data',f.args.imports=c?'enable':'unable',a.replaceLocation(f)},1e3)),e&&0<e.length){'function'==typeof g&&g();var h='';0!=e.length&&('enable'==c?y.find('span.nav-enable-num').text(e.length):z.find('span.nav-unable-num').text(e.length)),$.each(e,function(a){h+='<tr>                        <td class="user-index">'+(a+1)+'</td>                        <td class="user-name">'+e[a].name+'</td>                        <td class="user-employeenum">'+e[a].employee_num+'</td>                        <td class="user-deptname" title="'+e[a].dept_name+'">'+e[a].dept_name+'</td>                        <td class="user-title" title="'+e[a].title+'">'+e[a].title+'</td>                        <td class="user-mobile">'+e[a].mobile+'</td>                        '+(c&&'unable'==c?'<td class="user-error"><span class="red">\u901A\u8BAF\u5F55\u4E2D\u5DF2\u5B58\u5728\u8BE5\u624B\u673A\u53F7\u7801\u7684\u5458\u5DE5</span></td>':'')+'                    </tr>'}),b.append(h)}}function g(a,b,c){if(!!window.WebSocket&&window.WebSocket.prototype.send){var d=new WebSocket(a.ws_url);d.onopen=function(){console.log('\u5DF2\u8FDE\u63A5\u4E0A'),d.send('{"cmd": "register","data": "'+a.session_id+'"}')},d.onmessage=function(a){var d=JSON.parse(a.data);console.log('json',d),d&&(d.fail_list&&e(B,'unable',b,d.fail_list,function(){c()}),d.success_list&&e(A,'enable',b,d.success_list,function(){c()}))},d.onclose=function(){console.log('\u8FDE\u63A5\u5DF2\u5173\u95ED...'),'function'==typeof c&&c()},d.onerror=function(){'function'==typeof c&&c()}}else var f=setInterval(function(){h('/ws/'+a.session_id+'',f,function(){c()})},3e3)}function h(a,c,d){b.ajaxSubmit({url:a,silent:!0,type:'get',force:!0,complete:function complete(a){if(200==a.status){var b=JSON.parse(a.responseText);console.log('response',b),b&&(b.fail_list&&e(B,'unable',status,b.fail_list,function(){d()}),b.success_list&&e(A,'enable',status,b.success_list,function(){d()}))}}})}var i=$(d),k=$('#imports .imports-box'),l=k.find('.imports-info'),m=l.find('.imports-crumbs'),n=m.find('.imports-crumbs-user'),o=m.find('.imports-crumbs-info'),p=l.find('.imports-inner'),q=i.find('.btn-step-download'),r=i.find('.btn-step-upload'),s=i.find('#upload-form'),t=i.find('#upload-file');k.append(i);var u=k.find('.imports-steps'),v=p.find('.imports-inner-data .imports-nav a'),w=p.find('.imports-inner-data .imports-table'),x=p.find('.imports-upload button.btn-upload'),y=p.find('.imports-nav a.nav-enable'),z=p.find('.imports-nav a.nav-unable'),A=p.find('.imports-inner-data .imports-table .imports-table-enable .table-data-wrap table.table-data tbody.tbody'),B=p.find('.imports-inner-data .imports-table .imports-table-unable .table-data-wrap table.table-data tbody.tbody');v.on('click',function(b){b.stopPropagation();var d=$(this),c=d.index();d.hasClass('active')||(d.addClass('active').siblings().removeClass('active'),w.find('>div').eq(c).addClass('active').siblings().removeClass('active'),w.find('>div').eq(c).find('.table-data-wrap').addClass('active'),w.find('>div').eq(c).siblings().find('.table-data-wrap').removeClass('active')),f.args.imports=0==c?'enable':'unable',a.replaceLocation(f)}),s.on('change','#upload-file',function(){c()}),n.on('click',function(){f.args.type='info',f.args.status='data',a.replaceLocation(f)}),o.on('click',function(){f.args.type='steps',f.args.status='data',a.replaceLocation(f)}),x.on('click',function(b){b.stopPropagation(),$('#upload-file').val(''),f.args.type='info',f.args.status='data',f.args.imports='unable',a.replaceLocation(f)})}),function(){j&&!0==j&&($importsInfo.show(),$importsSteps.hide())}});