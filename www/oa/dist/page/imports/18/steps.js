'use strict';define(['common/kernel/kernel','site/util/util','page/imports/member','common/text/text!page/imports/steps.html!strip'],function(a,b,c,d){function f(){$('#upload-file').val(''),l=0,m=0,o=0,E.find('>').remove(),F.find('>').remove(),B.find('span.nav-enable-num').text(0),C.find('span.nav-unable-num').text(0)}var g,h,i=a.parseHash(location.hash),e=b.getCookie('userid'),j=b.getCookie('token'),k=b.getCookie('orgid'),l=0,m=0,o=0,n=!1,p=!!window.WebSocket&&window.WebSocket.prototype.send,q=$('#imports .imports-menu .menu-list .menu-manage-import'),r=$('#imports .imports-box'),s=r.find('.imports-info'),t=r.find('.imports-steps'),u=s.find('.imports-crumbs'),v=u.find('.imports-crumbs-user'),w=u.find('.imports-crumbs-info'),x=s.find('.imports-inner'),y=x.find('.imports-inner-data .imports-nav a'),z=x.find('.imports-inner-data .imports-table'),A=x.find('.imports-upload button.btn-upload'),B=x.find('.imports-nav a.nav-enable'),C=x.find('.imports-nav a.nav-unable'),D=x.find('.imports-inner-data .imports-table .table-data-wrap'),E=x.find('.imports-inner-data .imports-table .imports-table-enable .table-data-wrap table.table-data tbody.tbody'),F=x.find('.imports-inner-data .imports-table .imports-table-unable .table-data-wrap table.table-data tbody.tbody');return c(function(){function c(){a.showLoading();var c=b.getCookie('userid'),d=b.getCookie('token'),e=b.getCookie('orgid'),f=new Date().valueOf().toString();return $.ajaxFileUpload({url:'/web/v1.0/import/employee',secureuri:!1,fileElementId:'upload-file',dataType:'json',beforeSend:function beforeSend(b){b.setRequestHeader('Duagent','_web'),b.setRequestHeader('Dauth',c+' '+f+' '+a.buildDauth(c,d,f))},ajaxSend:function ajaxSend(b){b.setRequestHeader('Duagent','_web'),b.setRequestHeader('Dauth',c+' '+f+' '+a.buildDauth(c,d,f))},data:{org_id:e,Duagent:'_web',Dauth:c+' '+f+' '+a.buildDauth(c,d,f)},success:function success(b){var c=$.parseJSON(jQuery(b.responseText).text());if(0==c.code){n=!0;var b=c.data.result;b&&b.session_id&&j(b,function(){a.hideLoading()})}else a.hideLoading(),n=!1,i.args.type='steps',i.args.status='error',a.hint(c.msg,'error'),setTimeout(function(){i.args.type='steps',i.args.status='data',i.args.imports='unable',a.replaceLocation(i)},1e3);a.replaceLocation(i)},error:function error(b){var c=$.parseJSON(jQuery(b.responseText).text());if(0==c.code){n=!0;var b=c.data.result;b&&b.session_id&&j(b,function(){a.hideLoading()})}else a.hideLoading(),n=!1,i.args.type='steps',i.args.status='error',a.hint(c.msg,'error'),'9103101'==c.code?(x.find('p.user-error-title').hide(),x.find('p.authority-error-title').show()):(x.find('p.user-error-title').show(),x.find('p.authority-error-title').hide());a.replaceLocation(i)}}),!1}function e(b,c,d,e,f,g){if(0==d&&(b.find('>').remove(),'enable'==c?(a.hint('\u5BFC\u5165\u6210\u529F~'),i.args.type='steps',i.args.status='success',a.replaceLocation(i)):(a.hint('\u5BFC\u5165\u5931\u8D25~','error'),i.args.type='steps',i.args.status='error',a.replaceLocation(i)),setTimeout(function(){i.args.type='steps',i.args.status='data',i.args.imports=c&&'enable'==c?'enable':'unable',a.replaceLocation(i)},1e3)),e&&0<e.length){'function'==typeof g&&g();var h='';if(0!=e.length){var j=f+e.length;'enable'==c?B.find('span.nav-enable-num').text(j):C.find('span.nav-unable-num').text(j)}$.each(e,function(a){h+='<tr>                        <td class="user-index">'+(a+f+1)+'</td>                        <td class="user-name">'+e[a].name+'</td>                        <td class="user-employeenum">'+e[a].employee_num+'</td>                        <td class="user-deptname" title="'+e[a].dept_name+'">'+e[a].dept_name+'</td>                        <td class="user-title" title="'+e[a].title+'">'+e[a].title+'</td>                        <td class="user-mobile">'+e[a].mobile+'</td>                        '+(c&&'unable'==c?'<td class="user-error"><span class="red">'+(e[a].msg&&''!=e[a].msg?e[a].msg:'\u901A\u8BAF\u5F55\u4E2D\u5DF2\u5B58\u5728\u8BE5\u624B\u673A\u53F7\u7801\u7684\u5458\u5DE5')+'</span></td>':'')+'                    </tr>'}),b.append(h)}}function j(a,b){!!window.WebSocket&&window.WebSocket.prototype.send?(g=new WebSocket(a.ws_url),g.onopen=function(){g.send('{"cmd": "register","data": "'+a.session_id+'"}')},g.onmessage=function(a){var c=JSON.parse(a.data);c&&(c.fail_list&&(e(F,'unable',o,c.fail_list,m,function(){0==o&&b()}),o++,m+=c.fail_list.length),c.success_list&&(e(E,'enable',o,c.success_list,l,function(){0==o&&b()}),o++,l+=c.success_list.length))},g.onclose=function(){'function'==typeof b&&b()},g.onerror=function(){'function'==typeof b&&b()}):h=setInterval(function(){k('/ws/'+a.session_id+'',h,function(){b()})},3e3)}function k(a,c,d){b.ajaxSubmit({url:a,silent:!0,type:'get',force:!0,complete:function complete(a){if(200==a.status){var b=JSON.parse(a.responseText);b&&$.each(b,function(a,b){b.fail_list&&0<b.fail_list.length&&(e(F,'unable',o,b.fail_list,m,function(){0==status&&d()}),m+=b.fail_list.length,o++),b.success_list&&0<b.success_list.length&&(e(E,'enable',o,b.success_list,l,function(){0==status&&d()}),l+=b.success_list.length,o++)})}}})}var s=$(d),t=s.find('.btn-step-download'),u=s.find('.btn-step-upload'),G=s.find('#upload-form'),H=s.find('#upload-file');r.append(s),q.on('click',function(b){b.preventDefault(),f(),p?g&&g.close():h&&clearInterval(h),a.replaceLocation({id:'imports',args:{type:'info'}})}),y.on('click',function(b){b.stopPropagation();var d=$(this),c=d.index();d.hasClass('active')||(d.addClass('active').siblings().removeClass('active'),z.find('>div').eq(c).addClass('active').siblings().removeClass('active'),z.find('>div').eq(c).find('.table-data-wrap').addClass('active'),z.find('>div').eq(c).siblings().find('.table-data-wrap').removeClass('active')),i.args.imports=0==c?'enable':'unable',a.replaceLocation(i)}),G.on('change','#upload-file',function(){c(),D.height(document.body.clientHeight-376)}),v.on('click',function(){i.args.type='info',i.args.status='data',f(),p?g&&g.close():h&&clearInterval(h),a.replaceLocation(i)}),w.on('click',function(){i.args.type='steps',i.args.status='data',f(),p?g&&g.close():h&&clearInterval(h),a.replaceLocation(i)}),A.on('click',function(b){b.stopPropagation(),f(),p?g&&g.close():h&&clearInterval(h),a.replaceLocation({id:'imports',args:{}})})}),function(){f(),n&&!0==n&&(s.show(),t.hide())}});