'use strict';define(['common/kernel/kernel','site/util/util'],function(a,b){function c(b,c){b.data&&b.data.data&&(n.find('.user-wrap img.user-info-avatar').prop('src',b.data.data.avatar_url),n.find('.user-panel >.user-info >.userinfo-name-box b').text(b.data.data.name),n.find('.user-panel >.user-info img').prop('src',b.data.data.avatar_url)),b.data.orgindexadmin&&!0==b.data.orgindexadmin||a.replaceLocation({args:{},id:'appentry'}),d(b,c)}function d(c,d){for(var f=parseInt(b.getCookie('orgindex')?b.getCookie('orgindex'):0),h=0,j=b.getCookie('orgindexid'),k=d&&'choose'==d?c:c.data,l=k.organization,m=0;m<l.length;m++)l[m].id==j&&(f=m,b.setCookie('orgindex',m),h++);j&&l&&0>=h&&(f=-1),0<=f&&k.organization&&0<k.organization.length&&k.organization[f]?($('a.nav-item-current .navlink-type').html('group'==k.organization[f].type?'<i class="iconfont icon-group">&#xe643;</i>':'<i class="iconfont icon-user">&#xe642;</i>'),$('a.nav-item-current .navlink-name').text(k.organization[f].name),$('.nav-item-team .son-nav-wrap .son-nav-list-team').find('>').remove(),k.orgindex=f,k.organization[k.orgindex].id!=k.orgindexid&&(k.orgindexid=k.organization[k.orgindex].id),k.organization&&0<k.organization.length?$.each(k.organization,function(c,d){var h='group'==d.type?'<i class="iconfont icon-group">&#xe643;</i>':'<i class="iconfont icon-user">&#xe642;</i>',i=$('<a class="sub-nav-item '+(k.organization[f].id==d.id?'current':'')+'"  href="javascript:;" data-oid="'+d.id+'" data-pid="'+d.top_department_id+'">'+h+''+d.name+'</a>');return $('.nav-item-team .son-nav-wrap .son-nav-list-team').append(i),function(){i.on('click',function(f){var f=f||window.e;f.stopPropagation();var e=$(this),c=d.name;e.hasClass('current')||(i.parents('.nav-item-team').find('a.nav-item-current .navlink-type').html(h),i.parents('.nav-item-team').find('a.nav-item-current .navlink-name').text(c),e.siblings().removeClass('current'),e.addClass('current'),g({userid:k.data.id,orgid:k.organization[e.index()].id,token:b.getCookie('token')},k,e.index()),'imports'==a.parseHash(location.hash).id&&a.parseHash(location.hash).args.id&&a.replaceLocation({args:{},id:'imports'})),$('.nav-item-team .son-nav-wrap').hide()})}()}):e(c,d)):n.find('a.logout').trigger('click')}function e(c,d){var e=d&&'choose'==d?c:c.data;b.setCookie('userid',e.data.id),b.setCookie('orgid',e.organization[e.orgindex].id),b.setCookie('parentid',e.organization[e.orgindex].top_department_id),b.setCookie('orgname',e.organization[e.orgindex].name),b.setCookie('employee_count',e.organization[e.orgindex].employee_cnt),c.data.orgindexadmin&&!0==c.data.orgindexadmin?a.reloadPage(a.parseHash(location.hash).id):a.replaceLocation({args:{},id:'appentry'})}function f(b){'appentry'==a.parseHash(location.hash).id?b.orgindexadmin&&!0==b.orgindexadmin?(j.find('.navlink-user').show(),j.find('.navlink-admin').show(),j.find('.navlink-group').hide()):(j.find('.navlink-user').hide(),j.find('.navlink-admin').hide(),j.find('.navlink-group').show()):(j.find('.navlink-user').hide(),j.find('.navlink-admin').hide(),j.find('.navlink-group').show())}function g(c,d,g){var i=new Date().valueOf().toString(),j={};c.orgid?j.org_id=c.orgid:'',b.ajaxSubmit({type:'get',url:'/v1.0/user/me',dauth:c.userid+' '+i+' '+a.buildDauth(c.userid,c.token,i),data:j,success:function success(a){if(0==a.code){var i=a.data.organization;if(i){var j=d;b.isEqual(j.organization[j.orgindex],i[g])||(j.orgindex=g,j.orgindexid=i[g].id,j.data.id==i[g].admin_id?(console.log('orgindexadmin',!0),j.orgindexadmin=!0,b.setCookie('orgindex',j.orgindex),b.setCookie('orgindexid',j.orgindexid),b.setCookie('orgindexadmin',!0),b.setUserData(j),f(j),e(d,'choose')):h({userid:c.userid,token:c.token,orgid:c.orgid},function(a){console.log('orgindexadmin',a),j.orgindexadmin=a,b.setCookie('orgindex',j.orgindex),b.setCookie('orgindexid',j.orgindexid),b.setCookie('orgindexadmin',a),b.setUserData(j),f(j),e(d,'choose')})),b.setCookie('orgname',i[g].name),b.setCookie('employee_count',i[g].employee_cnt)}}}})}function h(c,d){var e=new Date().valueOf().toString();b.ajaxSubmit({type:'get',url:'/v1.0/admin/group/'+c.orgid+'',dauth:c.userid+' '+e+' '+a.buildDauth(c.userid,c.token,e),data:{},success:function success(b){if(0==b.code){var e=[];0<b.data.result.length&&$.each(b.data.result,function(a,b){$.each(b.admin_ids,function(a,b){e.push(b)})}),'function'==typeof d&&d(!!(0<=$.inArray(c.userid,e)))}else a.hint(b.msg)},error:function error(b){a.hint(b.msg)}})}var i=$('#header .user-head .nav-top .nav-top-list'),j=i.find('.nav-item'),k=i.find('.nav-item-team'),l=i.find('.nav-item-login'),m=l.find('.nologin'),n=l.find('.userBtn');window.PIE&&'Microsoft Internet Explorer'==navigator.appName&&'MSIE8.0'==navigator.appVersion.split(';')[1].replace(/[ ]/g,'')&&($('.nav-item-current').each(function(){PIE.attach(this)}),$('.user-wrap').each(function(){PIE.attach(this)}),$('.son-nav-list').each(function(){PIE.attach(this)}),$('.user-panel').each(function(){PIE.attach(this)}),$('.user-info-avatar').each(function(){PIE.attach(this)}),$('.userinfo-avatar').each(function(){PIE.attach(this)})),j.find('a.navlink').on('click',function(a){a.stopPropagation();var b=$(this);b.hasClass('navlink-current')||(b.parent('li.nav-item').siblings('li').find('>a.navlink').removeClass('navlink-current'),b.addClass('navlink-current'))}),$(document).on('scroll',function(){$(this).scrollTop()>$('#header').height()?$('#header .user-head').addClass('user-head-fixed'):$('#header .user-head').removeClass('user-head-fixed')}),$(document).on('mouseover','li.nav-item-team',function(){$('li.nav-item-team .son-nav-wrap').show()}),$(document).on('mouseout','li.nav-item-team',function(){$('li.nav-item-team .son-nav-wrap').hide()}),k.find('.son-nav-wrap a.sub-nav-item').on('click',function(a){var a=a||window.e;a.stopPropagation();var d=$(this),c=d.attr('data-pid');d.hasClass('current')||(d.siblings().removeClass('current'),d.addClass('current')),$('.son-nav-wrap').hide(),b.setCookie('parentid',c)}),n.find('a.logout').on('click',function(c){var c=c||window.e;c.stopPropagation();var d=b.getUserData().id,e=b.getUserData().token;b.delCookie('userid',void 0),b.delCookie('token',void 0),b.delCookie('orgid',void 0),b.delCookie('orgindex',void 0),b.delCookie('orgindexid',void 0),b.delCookie('orgindexadmin',void 0),b.delCookie('parentid',void 0),b.delCookie('orgname',void 0),b.delCookie('employee_count',void 0),b.setUserData(void 0,!0),a.replaceLocation({args:{},id:'loginhome'}),$('.loginQr').trigger('click')});var o;b.updateUserData(b.getCookie('userid'),b.getCookie('token'),function(){a.init('appentry')}),a.listeners.add(b.userEvents,'statechange',function(a){a.data?(m.hide(),n.addClass('hasLogin'),n.show(),k.show(),c(a)):(m.show(),n.removeClass('hasLogin'),n.hide(),k.hide())}),a.listeners.add(b.userEvents,'datachange',c),a.listeners.add(b.userEvents,'pagechange',e),a.listeners.add(a.pageEvents,'routend',function(){var b;a.lastLocation&&a.lastLocation.id!==a.location.id&&!o&&(b=Math.max(document.body.scrollTop,document.documentElement.scrollTop),0<b&&$('html,body').animate({scrollTop:0},b))})});