'use strict';define(['common/kernel/kernel','site/util/util'],function(a,b){function c(a,b){a.data&&a.data.data&&(m.find('.user-wrap img.user-info-avatar').prop('src',a.data.data.avatar_url),m.find('.user-panel >.user-info >.userinfo-name-box b').text(a.data.data.name),m.find('.user-panel >.user-info img').prop('src',a.data.data.avatar_url)),d(a,b)}function d(c,d){for(var g=parseInt(b.getCookie('orgindex')?b.getCookie('orgindex'):0),h=0,j=b.getCookie('orgindexid'),k=d&&'choose'==d?c:c.data,l=k.organization,n=0;n<l.length;n++)l[n].id==j&&(g=n,b.setCookie('orgindex',n),h++);j&&l&&0>=h&&(g=-1),0<=g&&k.organization&&0<k.organization.length&&k.organization[g]?($('a.nav-item-current .navlink-type').html('group'==k.organization[g].type?'<i class="iconfont icon-group">&#xe643;</i>':'<i class="iconfont icon-user">&#xe642;</i>'),$('a.nav-item-current .navlink-name').text(k.organization[g].name),$('.nav-item-team .son-nav-wrap .son-nav-list-team').find('>').remove(),k.orgindex=g,k.organization[k.orgindex].id!=k.orgindexid&&(k.orgindexid=k.organization[k.orgindex].id),k.organization&&0<k.organization.length?$.each(k.organization,function(c,d){var h='group'==d.type?'<i class="iconfont icon-group">&#xe643;</i>':'<i class="iconfont icon-user">&#xe642;</i>',i=$('<a class="sub-nav-item '+(k.organization[g].id==d.id?'current':'')+'"  href="javascript:;" data-oid="'+d.id+'" data-pid="'+d.top_department_id+'">'+h+''+d.name+'</a>');return $('.nav-item-team .son-nav-wrap .son-nav-list-team').append(i),function(){i.on('click',function(g){var g=g||window.e;g.stopPropagation();var e=$(this),c=d.name;e.hasClass('current')||(i.parents('.nav-item-team').find('a.nav-item-current .navlink-type').html(h),i.parents('.nav-item-team').find('a.nav-item-current .navlink-name').text(c),e.siblings().removeClass('current'),e.addClass('current'),f({userid:k.data.id,orgid:k.organization[e.index()].id,token:b.getCookie('token')},k,e.index()),'imports'==a.parseHash(location.hash).id&&a.parseHash(location.hash).args.id&&a.replaceLocation({args:{},id:'imports'})),$('.nav-item-team .son-nav-wrap').hide()})}()}):e(c,d)):m.find('a.logout').trigger('click')}function e(c,d){var e=d&&'choose'==d?c:c.data;e&&e.data&&e.data.id&&(b.setCookie('userid',e.data.id),b.setCookie('orgid',e.organization[e.orgindex].id),b.setCookie('parentid',e.organization[e.orgindex].top_department_id),b.setCookie('orgname',e.organization[e.orgindex].name),b.setCookie('employee_count',e.organization[e.orgindex].employee_cnt)),e&&(e.orgindexadmin&&!0==e.orgindexadmin?a.reloadPage(a.parseHash(location.hash).id):a.replaceLocation({args:{},id:'appentry'}))}function f(d,e,f){var h=new Date().valueOf().toString(),i={};d.orgid?i.org_id=d.orgid:'',b.ajaxSubmit({type:'get',url:'/v1.0/user/me',dauth:d.userid+' '+h+' '+a.buildDauth(d.userid,d.token,h),data:i,success:function success(a){if(0==a.code){var h=a.data.organization;if(h){var i=e;b.isEqual(i.organization[i.orgindex],h[f])||(i.orgindex=f,i.orgindexid=h[f].id,i.data.id==h[f].admin_id?(console.log('orgindexadmin',!0),i.orgindexadmin=!0,b.setCookie('orgindex',i.orgindex),b.setCookie('orgindexid',i.orgindexid),b.setCookie('orgindexadmin',!0),b.setUserData(i),c(i,'choose')):g({userid:d.userid,token:d.token,orgid:d.orgid},function(a){console.log('orgindexadmin',a),i.orgindexadmin=a,b.setCookie('orgindex',i.orgindex),b.setCookie('orgindexid',i.orgindexid),b.setCookie('orgindexadmin',a),b.setUserData(i),c(i,'choose')})),b.setCookie('orgname',h[f].name),b.setCookie('employee_count',h[f].employee_cnt)}}}})}function g(c,d){var e=new Date().valueOf().toString();b.ajaxSubmit({type:'get',url:'/v1.0/admin/group/'+c.orgid+'',dauth:c.userid+' '+e+' '+a.buildDauth(c.userid,c.token,e),data:{},success:function success(b){if(0==b.code){var e=[];0<b.data.result.length&&$.each(b.data.result,function(a,b){$.each(b.admin_ids,function(a,b){e.push(b)})}),'function'==typeof d&&d(!!(0<=$.inArray(c.userid,e)))}else a.hint(b.msg)},error:function error(b){a.hint(b.msg)}})}var h=$('#header .user-head .nav-top .nav-top-list'),i=h.find('.nav-item'),j=h.find('.nav-item-team'),k=h.find('.nav-item-login'),l=k.find('.nologin'),m=k.find('.userBtn');window.PIE&&'Microsoft Internet Explorer'==navigator.appName&&'MSIE8.0'==navigator.appVersion.split(';')[1].replace(/[ ]/g,'')&&($('.nav-item-current').each(function(){PIE.attach(this)}),$('.user-wrap').each(function(){PIE.attach(this)}),$('.son-nav-list').each(function(){PIE.attach(this)}),$('.user-panel').each(function(){PIE.attach(this)}),$('.user-info-avatar').each(function(){PIE.attach(this)}),$('.userinfo-avatar').each(function(){PIE.attach(this)})),i.find('a.navlink').on('click',function(a){a.stopPropagation();var b=$(this);b.hasClass('navlink-current')||(b.parent('li.nav-item').siblings('li').find('>a.navlink').removeClass('navlink-current'),b.addClass('navlink-current'))}),$(document).on('scroll',function(){$(this).scrollTop()>$('#header').height()?$('#header .user-head').addClass('user-head-fixed'):$('#header .user-head').removeClass('user-head-fixed')}),$(document).on('mouseover','li.nav-item-team',function(){$('li.nav-item-team .son-nav-wrap').show()}),$(document).on('mouseout','li.nav-item-team',function(){$('li.nav-item-team .son-nav-wrap').hide()}),j.find('.son-nav-wrap a.sub-nav-item').on('click',function(a){var a=a||window.e;a.stopPropagation();var d=$(this),c=d.attr('data-pid');d.hasClass('current')||(d.siblings().removeClass('current'),d.addClass('current')),$('.son-nav-wrap').hide(),b.setCookie('parentid',c)}),m.find('a.logout').on('click',function(c){var c=c||window.e;c.stopPropagation();var d=b.getUserData().id,e=b.getUserData().token;b.delCookie('userid',void 0),b.delCookie('token',void 0),b.delCookie('orgid',void 0),b.delCookie('orgindex',void 0),b.delCookie('orgindexid',void 0),b.delCookie('orgindexadmin',void 0),b.delCookie('parentid',void 0),b.delCookie('orgname',void 0),b.delCookie('employee_count',void 0),b.setUserData(void 0,!0),a.replaceLocation({args:{},id:'loginhome'}),$('.loginQr').trigger('click')});var n;b.updateUserData(b.getCookie('userid'),b.getCookie('token'),function(){a.init('appentry')}),a.listeners.add(b.userEvents,'statechange',function(a){a.data?(l.hide(),m.addClass('hasLogin'),m.show(),j.show(),c(a)):(l.show(),m.removeClass('hasLogin'),m.hide(),j.hide())}),a.listeners.add(b.userEvents,'datachange',c),a.listeners.add(b.userEvents,'pagechange',e),a.listeners.add(a.pageEvents,'routend',function(){var b;a.lastLocation&&a.lastLocation.id!==a.location.id&&!n&&(b=Math.max(document.body.scrollTop,document.documentElement.scrollTop),0<b&&$('html,body').animate({scrollTop:0},b))})});